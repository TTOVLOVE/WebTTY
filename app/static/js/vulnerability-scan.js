class VulnerabilityScan {
    constructor() {
        this.currentScanId = null;
        this.statusTimer = null;
        this.socket = null;
        this.dom = {};
        this.init();
    }

    init() {
        this.cacheDom();
        this.bindEvents();
        this.toggleCustomOptions(false);
        this.loadClients();
        this.loadScanHistory();
        this.checkCurrentScanStatus();
        this.initSocket();
    }

    cacheDom() {
        this.dom.navLinks = Array.from(document.querySelectorAll(".nav-link[data-tab]"));
        this.dom.scanForm = document.getElementById("scanForm");
        this.dom.scanType = document.getElementById("scanType");
        this.dom.scanTarget = document.getElementById("scanTarget");
        this.dom.customOptions = document.getElementById("customOptions");
        this.dom.portScan = document.getElementById("portScan");
        this.dom.serviceScan = document.getElementById("serviceScan");
        this.dom.vulnScan = document.getElementById("vulnScan");
        this.dom.startScanBtn = document.getElementById("startScanBtn");
        this.dom.stopScanBtn = document.getElementById("stopScanBtn");
        this.dom.currentScanStatus = document.getElementById("currentScanStatus");
        this.dom.noActiveScan = document.getElementById("noActiveScan");
        this.dom.statusIndicator = document.getElementById("statusIndicator");
        this.dom.statusText = document.getElementById("statusText");
        this.dom.progressBar = document.getElementById("progressBar");
        this.dom.progressText = document.getElementById("progressText");
        this.dom.scanMessage = document.getElementById("scanMessage");
        this.dom.vulnerabilityResults = document.getElementById("vulnerabilityResults");
        this.dom.vulnerabilityList = document.getElementById("vulnerabilityList");
        this.dom.historyContent = document.getElementById("historyContent");
    }

    bindEvents() {
        this.dom.navLinks.forEach((link) => {
            link.addEventListener("click", (event) => {
                const tab = event.currentTarget.dataset.tab;
                this.switchTab(tab);
            });
        });

        if (this.dom.scanType) {
            this.dom.scanType.addEventListener("change", (event) => {
                this.toggleCustomOptions(event.target.value === "custom");
            });
        }

        if (this.dom.scanForm) {
            this.dom.scanForm.addEventListener("submit", (event) => {
                event.preventDefault();
                this.startScan();
            });
        }

        if (this.dom.stopScanBtn) {
            this.dom.stopScanBtn.addEventListener("click", () => this.stopScan());
        }
    }

    switchTab(tabId) {
        this.dom.navLinks.forEach((link) => {
            link.classList.toggle("active", link.dataset.tab === tabId);
        });

        document.querySelectorAll(".tab-content").forEach((pane) => {
            pane.classList.toggle("active", pane.id === tabId);
            pane.classList.toggle("show", pane.id === tabId);
        });

        if (tabId === "history-tab") {
            this.loadScanHistory();
        }
    }

    toggleCustomOptions(visible) {
        if (this.dom.customOptions) {
            this.dom.customOptions.style.display = visible ? "block" : "none";
        }
    }

    async loadClients() {
        if (!this.dom.scanTarget) {
            return;
        }
        this.dom.scanTarget.innerHTML = `<option value="">正在加载客户端...</option>`;
        try {
            const response = await fetch("/api/vulnerability-scan/clients");
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "获取客户端失败");
            }
            const options = data.clients
                .map(
                    (client) =>
                        `<option value="${client.id}">${client.display_name} (${client.ip})</option>`,
                )
                .join("");
            this.dom.scanTarget.innerHTML =
                `<option value="">请选择要扫描的客户端</option>` + options;
        } catch (error) {
            console.error("加载客户端失败:", error);
            this.dom.scanTarget.innerHTML = `<option value="">无法加载客户端</option>`;
            this.showAlert(error.message || "加载客户端失败", "danger");
        }
    }

    async startScan() {
        if (!this.dom.scanTarget) {
            return;
        }

        const clientId = this.dom.scanTarget.value;
        const scanType = this.dom.scanType ? this.dom.scanType.value : "basic";

        if (!clientId) {
            this.showAlert("请选择要扫描的客户端", "warning");
            return;
        }

        const options = scanType === "custom"
            ? {
                  portScan: Boolean(this.dom.portScan?.checked),
                  serviceScan: Boolean(this.dom.serviceScan?.checked),
                  vulnScan: Boolean(this.dom.vulnScan?.checked),
              }
            : {};

        this.updateScanControls(true);
        this.showCurrentStatus(true);
        this.updateStatusView({
            status: "running",
            progress: 5,
            message: "正在启动扫描任务...",
            results: [],
        });

        try {
            const response = await fetch("/api/vulnerability-scan/start", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    target: clientId,
                    scan_type: scanType,
                    options,
                }),
            });
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "启动扫描失败");
            }

            this.currentScanId = data.task_id;
            this.showAlert("扫描任务已启动", "success");
            this.startStatusPolling(data.task_id);
        } catch (error) {
            console.error("启动扫描失败:", error);
            this.updateScanControls(false);
            this.showCurrentStatus(false);
            this.showAlert(error.message || "启动扫描失败", "danger");
        }
    }

    updateScanControls(isRunning) {
        if (this.dom.startScanBtn) {
            this.dom.startScanBtn.disabled = isRunning;
        }
        if (this.dom.stopScanBtn) {
            this.dom.stopScanBtn.style.display = isRunning ? "inline-block" : "none";
            this.dom.stopScanBtn.disabled = !isRunning;
        }
        if (this.dom.scanTarget) {
            this.dom.scanTarget.disabled = isRunning;
        }
        if (this.dom.scanType) {
            this.dom.scanType.disabled = isRunning;
        }
        if (this.dom.customOptions) {
            this.dom.customOptions.querySelectorAll("input").forEach((input) => {
                input.disabled = isRunning;
            });
        }
    }

    showCurrentStatus(visible) {
        if (!this.dom.currentScanStatus || !this.dom.noActiveScan) {
            return;
        }
        this.dom.currentScanStatus.style.display = visible ? "block" : "none";
        this.dom.noActiveScan.style.display = visible ? "none" : "block";
    }

    startStatusPolling(taskId) {
        this.stopStatusPolling();
        this.statusTimer = window.setInterval(() => this.pollStatus(taskId), 3000);
        this.pollStatus(taskId);
    }

    stopStatusPolling() {
        if (this.statusTimer) {
            window.clearInterval(this.statusTimer);
            this.statusTimer = null;
        }
    }

    async pollStatus(taskId) {
        try {
            const response = await fetch(`/api/vulnerability-scan/status/${taskId}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "获取扫描状态失败");
            }
            this.updateStatusView(data);
            if (data.status && !["running", "stopping"].includes(data.status)) {
                this.stopStatusPolling();
                this.updateScanControls(false);
                this.currentScanId = null;
                this.loadScanHistory();
            }
        } catch (error) {
            console.error("获取扫描状态失败:", error);
            this.showAlert(error.message || "获取扫描状态失败", "danger");
            this.stopStatusPolling();
            this.updateScanControls(false);
            this.currentScanId = null;
        }
    }

    updateStatusView(data) {
        if (!this.dom.statusIndicator || !this.dom.progressBar) {
            return;
        }

        const status = data.status || "running";
        const progress = Number.isFinite(data.progress) ? data.progress : 0;
        this.setStatusIndicator(status);
        if (this.dom.progressBar) {
            this.dom.progressBar.style.width = `${progress}%`;
        }
        if (this.dom.progressText) {
            this.dom.progressText.textContent = `${Math.max(progress, 0)}%`;
        }
        if (this.dom.statusText) {
            this.dom.statusText.textContent = this.getStatusLabel(status);
        }
        if (this.dom.scanMessage) {
            this.dom.scanMessage.textContent = data.message || "";
        }

        this.showCurrentStatus(true);
        this.updateScanControls(["running", "stopping"].includes(status));
        this.displayVulnerabilities(data.vulnerabilities || data.results || []);
    }

    setStatusIndicator(status) {
        if (!this.dom.statusIndicator) {
            return;
        }
        const indicator = this.dom.statusIndicator;
        indicator.className = "status-indicator";
        indicator.classList.add(`status-${status}`);
    }

    displayVulnerabilities(vulnerabilities) {
        if (!this.dom.vulnerabilityResults || !this.dom.vulnerabilityList) {
            return;
        }

        if (!vulnerabilities || vulnerabilities.length === 0) {
            this.dom.vulnerabilityResults.style.display = "none";
            this.dom.vulnerabilityList.innerHTML = "";
            return;
        }

        const listHtml = vulnerabilities
            .map(
                (item) => `
                <div class="vulnerability-item ${item.severity || "low"}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>${item.vulnerability || "未知漏洞"}</strong>
                        <span class="severity-badge severity-${item.severity || "low"}">
                            ${(item.severity || "low").toUpperCase()}
                        </span>
                    </div>
                    <div class="mb-2">${item.description || "暂无描述"}</div>
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt"></i> ${item.location || "-"}
                    </div>
                    <div class="mt-2 small">
                        <strong>修复建议：</strong> ${item.recommendation || "暂无"}
                    </div>
                </div>
            `,
            )
            .join("");

        this.dom.vulnerabilityList.innerHTML = listHtml;
        this.dom.vulnerabilityResults.style.display = "block";
    }

    async stopScan() {
        if (!this.currentScanId) {
            return;
        }
        try {
            const response = await fetch(
                `/api/vulnerability-scan/stop/${this.currentScanId}`,
                { method: "POST" },
            );
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "停止扫描失败");
            }
            this.showAlert("已发送停止指令", "info");
        } catch (error) {
            console.error("停止扫描失败:", error);
            this.showAlert(error.message || "停止扫描失败", "danger");
        }
    }

    async checkCurrentScanStatus() {
        try {
            const response = await fetch("/api/vulnerability-scan/status/current");
            const data = await response.json();
            if (data.success && data.scan_id) {
                this.currentScanId = data.scan_id;
                this.updateStatusView(data);
                if (["running", "stopping"].includes(data.status)) {
                    this.startStatusPolling(data.scan_id);
                }
            } else {
                this.showCurrentStatus(false);
            }
        } catch (error) {
            console.error("检测当前扫描状态失败:", error);
            this.showCurrentStatus(false);
        }
    }

    async loadScanHistory() {
        if (!this.dom.historyContent) {
            return;
        }
        this.dom.historyContent.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>正在加载扫描历史...</p>
            </div>
        `;
        try {
            const response = await fetch("/api/vulnerability-scan/history");
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "获取扫描历史失败");
            }
            this.renderHistory(data.history || []);
        } catch (error) {
            console.error("加载扫描历史失败:", error);
            this.dom.historyContent.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>${error.message || "加载扫描历史失败"}</p>
                </div>
            `;
        }
    }

    renderHistory(history) {
        if (!history.length) {
            this.dom.historyContent.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <p>暂无扫描历史记录</p>
                </div>
            `;
            return;
        }

        const rows = history
            .map(
                (scan) => `
                    <tr>
                        <td>${this.formatDateTime(scan.start_time)}</td>
                        <td>${scan.target_name || scan.target || "-"}</td>
                        <td>${this.getScanTypeLabel(scan.scan_type)}</td>
                        <td>
                            <span class="status-indicator status-${scan.status}"></span>
                            ${this.getStatusLabel(scan.status)}
                        </td>
                        <td>${(scan.results || scan.vulnerabilities || []).length}</td>
                        <td class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="vulnScan.viewScanDetails('${scan.task_id}')">
                                查看详情
                            </button>
                            ${
                                scan.report_url
                                    ? `
                                <button class="btn btn-sm btn-outline-secondary" onclick="vulnScan.downloadReport('${scan.task_id}', 'html')">
                                    导出 HTML
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="vulnScan.downloadReport('${scan.task_id}', 'pdf')">
                                    导出 PDF
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="vulnScan.downloadReport('${scan.task_id}', 'txt')">
                                    导出日志
                                </button>
                            `
                                    : ""
                            }
                        </td>
                    </tr>
                `,
            )
            .join("");

        this.dom.historyContent.innerHTML = `
            <div class="table-responsive">
                <table class="table history-table">
                    <thead>
                        <tr>
                            <th>开始时间</th>
                            <th>扫描目标</th>
                            <th>扫描类型</th>
                            <th>状态</th>
                            <th>漏洞数量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
    }

    getScanTypeLabel(type) {
        const map = {
            basic: "基础扫描",
            comprehensive: "全面扫描",
            custom: "自定义扫描",
        };
        return map[type] || type || "-";
    }

    getStatusLabel(status) {
        const map = {
            pending: "等待中",
            running: "扫描中",
            stopping: "正在停止",
            stopped: "已停止",
            completed: "已完成",
            failed: "失败",
            cancelled: "已取消",
        };
        return map[status] || status || "-";
    }

    formatDateTime(value) {
        if (!value) {
            return "-";
        }
        try {
            return new Date(value).toLocaleString();
        } catch {
            return value;
        }
    }

    async viewScanDetails(taskId) {
        try {
            const response = await fetch(`/api/vulnerability-scan/details/${taskId}`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.message || "获取扫描详情失败");
            }
            this.showScanDetailsModal(data.details);
        } catch (error) {
            console.error("获取扫描详情失败:", error);
            this.showAlert(error.message || "获取扫描详情失败", "danger");
        }
    }

    showScanDetailsModal(details) {
        const existing = document.getElementById("scanDetailsModal");
        if (existing) {
            existing.remove();
        }

        const vulnerabilities = details.vulnerabilities || details.results || [];
        const vulnerabilitiesHtml = vulnerabilities.length
            ? vulnerabilities
                  .map(
                      (item) => `
                    <div class="vulnerability-item ${item.severity || "low"}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${item.vulnerability || "未知漏洞"}</strong>
                            <span class="severity-badge severity-${item.severity || "low"}">
                                ${(item.severity || "low").toUpperCase()}
                            </span>
                        </div>
                        <p>${item.description || "暂无描述"}</p>
                        <div class="small text-muted">
                            <i class="fas fa-map-marker-alt"></i> ${item.location || "-"}
                        </div>
                        <div class="mt-2 small">
                            <strong>建议：</strong> ${item.recommendation || "暂无"}
                        </div>
                    </div>
                `,
                  )
                  .join("")
            : `<div class="alert alert-success mb-0">未发现安全漏洞</div>`;

        const rawOutput = (details.raw_output || [])
            .map((line) => this.escapeHtml(line))
            .join("<br>");

        const modalHtml = `
            <div class="modal fade" id="scanDetailsModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-search"></i> 扫描详情 - ${details.target || "-"}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle"></i> 基本信息</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr><td>扫描目标</td><td>${details.target || "-"}</td></tr>
                                            <tr><td>扫描类型</td><td>${this.getScanTypeLabel(details.scan_type)}</td></tr>
                                            <tr><td>开始时间</td><td>${this.formatDateTime(details.start_time)}</td></tr>
                                            <tr><td>结束时间</td><td>${this.formatDateTime(details.end_time)}</td></tr>
                                            <tr><td>状态</td><td>${this.getStatusLabel(details.status)}</td></tr>
                                            <tr><td>进度</td><td>${details.progress ?? 0}%</td></tr>
                                            <tr><td>IP 地址</td><td>${details.target_ip || "-"}</td></tr>
                                        </tbody>
                                    </table>
                                    ${
                                        details.report_url
                                            ? `
                                        <div class="mt-3 d-flex flex-wrap gap-2">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="vulnScan.downloadReport('${details.task_id}', 'html')">导出 HTML</button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="vulnScan.downloadReport('${details.task_id}', 'pdf')">导出 PDF</button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="vulnScan.downloadReport('${details.task_id}', 'txt')">导出日志</button>
                                        </div>
                                    `
                                            : ""
                                    }
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-bug"></i> 漏洞详情</h6>
                                    <div class="vulnerability-scroll">${vulnerabilitiesHtml}</div>
                                </div>
                            </div>
                            ${
                                rawOutput
                                    ? `
                                <div class="mt-4">
                                    <h6><i class="fas fa-file-alt"></i> 扫描日志</h6>
                                    <div class="log-block">${rawOutput}</div>
                                </div>
                            `
                                    : ""
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        const modalElement = document.getElementById("scanDetailsModal");
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        modalElement.addEventListener("hidden.bs.modal", () => modalElement.remove(), {
            once: true,
        });
    }

    escapeHtml(value) {
        return value
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    downloadReport(taskId, format) {
        if (!taskId) {
            this.showAlert("无法导出报告，缺少任务 ID", "warning");
            return;
        }
        const url = `/api/vulnerability-scan/report/${taskId}?format=${format}`;
        window.open(url, "_blank");
    }

    initSocket() {
        if (typeof io === "undefined") {
            return;
        }
        try {
            this.socket = io();
            this.socket.on("vulnerability_scan_event", (event) => this.handleScanEvent(event));
        } catch (error) {
            console.warn("初始化 Socket 通知失败:", error);
        }
    }

    handleScanEvent(event) {
        if (!event || !event.task_id) {
            return;
        }

        const status = event.status || "running";
        const message = event.message || "扫描状态更新";

        if (event.task_id === this.currentScanId) {
            this.updateStatusView({
                status,
                progress: event.progress ?? 0,
                message,
                results: event.results || [],
                vulnerabilities: event.results || [],
            });

            if (!["running", "stopping"].includes(status)) {
                this.stopStatusPolling();
                this.updateScanControls(false);
                this.currentScanId = null;
                this.loadScanHistory();
            }
        } else {
            this.loadScanHistory();
        }

        const level = status === "failed" ? "danger" : status === "completed" ? "success" : "info";
        this.showAlert(message, level);
    }

    showAlert(message, level = "info") {
        const containerId = "scan-alert-container";
        let container = document.getElementById(containerId);
        if (!container) {
            container = document.createElement("div");
            container.id = containerId;
            container.style.position = "fixed";
            container.style.top = "20px";
            container.style.right = "20px";
            container.style.zIndex = "1055";
            document.body.appendChild(container);
        }

        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${level}`;
        alertDiv.role = "alert";
        alertDiv.textContent = message;
        container.appendChild(alertDiv);

        window.setTimeout(() => {
            alertDiv.classList.add("fade");
            window.setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    window.vulnScan = new VulnerabilityScan();
});
