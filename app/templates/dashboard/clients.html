{% extends "dashboard/base.html" %}

{% block title %}客户端列表 - WebTTY{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">
    <i class='bx bx-devices'></i>
    <div>
      <h1>客户端列表</h1>
      <p class="page-subtitle">管理和监控所有连接的客户端</p>
    </div>
  </div>
  <div class="page-actions">
    <button class="btn btn-secondary" onclick="refreshClientList()">
      <i class='bx bx-refresh'></i>
      刷新列表
    </button>
  </div>
</div>

<div id="client-list" class="animate-fade-in">
  <div class="text-center py-4">
    <i class='bx bx-loader-alt bx-spin'></i>
    <h5>正在加载客户端列表...</h5>
    <p>请稍候</p>
  </div>
</div>

{% include 'dashboard/modals/file_manager_modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-manager-modal.js') }}"></script>
<script>
let socket;
let clientsState = {};
let hasConnected = false; // Flag to track initial connection

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    requestClientList();
});

function initializeSocket() {
    socket = io();
    
    socket.on('connect', () => {
        if (!hasConnected) {
            console.log('已连接到服务器');
            hasConnected = true;
        }
        requestClientList();
    });
    
    socket.on('clients_list', (data) => {
        clientsState = data && data.clients ? data.clients : {};
        updateClientList(clientsState);
    });
    
    socket.on('new_client', (clientData) => {
        console.log('新客户端连接:', clientData);
        const id = String(clientData.id);
        clientsState[id] = {
            ...(clientsState[id] || {}),
            id,
            addr: clientData.addr,
            user: (clientsState[id] && clientsState[id].user) || '获取中...',
            initial_cwd: (clientsState[id] && clientsState[id].initial_cwd) || '获取中...',
            os: (clientsState[id] && clientsState[id].os) || '获取中...'
        };
        updateClientList(clientsState);
    });
    
    socket.on('client_updated', (clientData) => {
        console.log('客户端信息更新:', clientData);
        const id = String(clientData.id);
        clientsState[id] = {
            ...(clientsState[id] || {}),
            ...clientData
        };
        updateClientList(clientsState);
    });
    
    socket.on('client_disconnected', (data) => {
        console.log('客户端断开连接:', data);
        const id = String(data.id);
        delete clientsState[id];
        updateClientList(clientsState);
    });

    socket.on('status_update', (data) => {
        const statusEl = document.getElementById(`status-details-${data.client_id}`);
        if (statusEl) {
            statusEl.textContent = `CPU: ${data.cpu_percent.toFixed(1)}% | Mem: ${data.mem_percent.toFixed(1)}%`;
        }
    });
}

function requestClientList() {
    console.log('请求客户端列表...');
    socket.emit('get_clients');
}

function refreshClientList() {
    requestClientList();
}

// 为 /clients 页面提供统一的显示名称函数，避免出现“客户端0”
function getClientDisplayName(clientId, client) {
    // 统一规范化：转字符串并过滤占位值
    const norm = (val) => {
        if (val === null || val === undefined) return '';
        const s = String(val).trim();
        if (!s) return '';
        if (s === '未知' || s === '获取中...') return '';
        return s;
    };

    try {
        // 1) hostname（可能为数字）
        const host = norm(client && client.hostname);
        if (host) return host;
        
        // 2) name
        const name = norm(client && client.name);
        if (name) return name;
        
        // 3) user（可能为数字）
        const user = norm(client && client.user);
        if (user) return user;
        
        // 4) addr（可能为数组 [ip, port] 或字符串 "ip,port" 或 "('ip', port)"）
        if (client && client.addr) {
            if (Array.isArray(client.addr) && client.addr.length > 0) {
                const ip = norm(client.addr[0]);
                if (ip) return ip;
            }
            const addrStr = norm(client.addr);
            if (addrStr) {
                // 尝试从字符串中提取IP部分
                const m = addrStr.match(/([0-9]{1,3}(?:\.[0-9]{1,3}){3})/);
                if (m && m[1]) return m[1];
                return addrStr;
            }
        }
        
        // 5) 其他可能字段
        const ip = norm(client && (client.ip || client.ip_address));
        if (ip) return ip;
    } catch (e) {
        console.warn('getClientDisplayName error:', e, clientId, client);
    }
    return `客户端 ${clientId}`;
}

function updateClientList(clients) {
    const container = document.getElementById('client-list');
    const clientIds = Object.keys(clients || clientsState || {});
    
    if (clientIds.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class='bx bx-devices'></i>
                <h3>暂无在线客户端</h3>
                <p>等待客户端连接...</p>
            </div>
        `;
        return;
    }
    
    const clientCards = clientIds.map(clientId => {
        const client = (clients || clientsState)[clientId];
        const displayName = client.display_name || getClientDisplayName(clientId, client);
        if (displayName === `客户端 ${clientId}`) {
            console.debug('[clients] 未找到更优名称，使用默认回退', { clientId, client });
        }
        return `
            <div class="client-card">
                <div class="card-body">
                    <div class="client-header">
                        <div class="client-info">
                            <h5 class="client-title">
                                <i class='bx bx-laptop'></i>
                                ${displayName}
                            </h5>
                            <div class="client-details">
                                <div class="detail-item">
                                    <i class='bx bx-user'></i>
                                    <span>用户: ${client.user || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-map'></i>
                                    <span>IP: ${(Array.isArray(client.addr) ? client.addr[0] : (client.addr || client.ip || client.ip_address || '未知'))}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-desktop'></i>
                                    <span>系统: ${client.os || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-folder'></i>
                                    <span>目录: ${client.initial_cwd || '未知'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="client-status-area">
                            <div class="status-indicator online">
                                <div class="status-dot"></div>
                                <span>在线</span>
                            </div>
                            <div class="connection-time">
                                <small class="text-muted">连接于: ${new Date(client.connect_time || Date.now()).toLocaleTimeString()}</small>
                            </div>
                            <div class="status-details">
                                <small class="text-muted" id="status-details-${clientId}">CPU: --% | Mem: --%</small>
                            </div>
                        </div>
                    </div>
                    <div class="client-actions">
                        <a href="{{ url_for('dashboard.index') }}?client=${clientId}" class="btn btn-primary btn-sm me-2">
                            <i class='bx bx-terminal'></i> 终端
                        </a>
                        <button class="btn btn-info btn-sm me-2" onclick="openFileManagerModal('${clientId}')">
                            <i class='bx bx-folder'></i> 文件管理
                        </button>
                        <button class="btn btn-success btn-sm me-2" onclick="takeScreenshot('${clientId}')">
                            <i class='bx bx-camera'></i> 截图
                        </button>
                        <a href="{{ url_for('dashboard.remote_control') }}?client=${clientId}" class="btn btn-warning btn-sm">
                            <i class='bx bx-mobile-alt'></i> 远程控制
                        </a>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = clientCards;
}

function takeScreenshot(clientId) {
    socket.emit('send_command', {
        target: clientId,
        command: { action: 'screenshot', arg: '' }
    });
    alert('截图命令已发送');
}

// --- File Manager Modal Functions ---
function openFileManagerModal(clientId) {
    const modal = document.getElementById('fileManagerModal');
    if (!modal) {
        console.error('File manager modal not found!');
        return;
    }
    document.getElementById('fm-client-id').textContent = clientId;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
    
    // Initialize or re-initialize the file manager for this client
    if (window.modalFileManager) {
        window.modalFileManager.connectToClient(clientId);
    }
}

function closeFileManagerModal() {
    const modal = document.getElementById('fileManagerModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
    if (window.modalFileManager) {
        window.modalFileManager.disconnectFromClient();
    }
}
</script>

<style>
.client-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.client-status-area {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
}

.status-details {
    margin-top: 0.5rem;
}
</style>
{% endblock %}

