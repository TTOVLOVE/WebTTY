{% extends "dashboard/base.html" %}

{% block title %}客户端列表 - WebTTY{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">
    <i class='bx bx-devices'></i>
    <div>
      <h1>客户端列表</h1>
      <p class="page-subtitle">管理和监控所有连接的客户端</p>
    </div>
  </div>
  <div class="page-actions">
    <button class="btn btn-secondary" onclick="refreshClientList()">
      <i class='bx bx-refresh'></i>
      刷新列表
    </button>
  </div>
</div>

<div id="client-list" class="animate-fade-in">
  <div class="text-center py-4">
    <i class='bx bx-loader-alt bx-spin'></i>
    <h5>正在加载客户端列表...</h5>
    <p>请稍候</p>
  </div>
</div>

{% include 'dashboard/modals/file_manager_modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-manager-modal.js') }}"></script>
<script>
let socket;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    requestClientList();
});

function initializeSocket() {
    socket = io();
    
    socket.on('connect', () => {
        console.log('已连接到服务器');
        requestClientList();
    });
    
    socket.on('clients_list', (data) => {
        updateClientList(data.clients);
    });
    
    socket.on('new_client', (clientData) => {
        console.log('新客户端连接:', clientData);
        requestClientList();
    });
    
    socket.on('client_updated', (clientData) => {
        console.log('客户端信息更新:', clientData);
        requestClientList();
    });
    
    socket.on('client_disconnected', (data) => {
        console.log('客户端断开连接:', data);
        requestClientList();
    });

    socket.on('status_update', (data) => {
        const statusEl = document.getElementById(`status-details-${data.client_id}`);
        if (statusEl) {
            statusEl.textContent = `CPU: ${data.cpu_percent.toFixed(1)}% | Mem: ${data.mem_percent.toFixed(1)}%`;
        }
    });
}

function requestClientList() {
    console.log('请求客户端列表...');
    socket.emit('get_clients');
}

function refreshClientList() {
    requestClientList();
}

function updateClientList(clients) {
    const container = document.getElementById('client-list');
    const clientIds = Object.keys(clients || {});
    
    if (clientIds.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class='bx bx-devices'></i>
                <h3>暂无在线客户端</h3>
                <p>等待客户端连接...</p>
            </div>
        `;
        return;
    }
    
    const clientCards = clientIds.map(clientId => {
        const client = clients[clientId];
        return `
            <div class="client-card">
                <div class="card-body">
                    <div class="client-header">
                        <div class="client-info">
                            <h5 class="client-title">
                                <i class='bx bx-laptop'></i>
                                客户端 ${clientId}
                            </h5>
                            <div class="client-details">
                                <div class="detail-item">
                                    <i class='bx bx-user'></i>
                                    <span>用户: ${client.user || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-map'></i>
                                    <span>IP: ${client.addr || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-desktop'></i>
                                    <span>系统: ${client.os || '未知'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class='bx bx-folder'></i>
                                    <span>目录: ${client.initial_cwd || '未知'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="client-status-area">
                            <div class="status-indicator online">
                                <div class="status-dot"></div>
                                <span>在线</span>
                            </div>
                            <div class="connection-time">
                                <small class="text-muted">连接于: ${new Date(client.connect_time || Date.now()).toLocaleTimeString()}</small>
                            </div>
                            <div class="status-details">
                                <!-- 新的状态信息将显示在这里 -->
                                <small class="text-muted" id="status-details-${clientId}">CPU: --% | Mem: --%</small>
                            </div>
                        </div>
                    </div>
                    <div class="client-actions">
                        <a href="{{ url_for('dashboard.index') }}?client=${clientId}" class="btn btn-primary btn-sm me-2">
                            <i class='bx bx-terminal'></i> 终端
                        </a>
                        <button class="btn btn-info btn-sm me-2" onclick="openFileManagerModal('${clientId}')">
                            <i class='bx bx-folder'></i> 文件管理
                        </button>
                        <button class="btn btn-success btn-sm me-2" onclick="takeScreenshot('${clientId}')">
                            <i class='bx bx-camera'></i> 截图
                        </button>
                        <a href="{{ url_for('dashboard.remote_control') }}?client=${clientId}" class="btn btn-warning btn-sm">
                            <i class='bx bx-mobile-alt'></i> 远程控制
                        </a>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = clientCards;
}

function takeScreenshot(clientId) {
    socket.emit('send_command', {
        target: clientId,
        command: { action: 'screenshot', arg: '' }
    });
    alert('截图命令已发送');
}

// --- File Manager Modal Functions ---
function openFileManagerModal(clientId) {
    const modal = document.getElementById('fileManagerModal');
    if (!modal) {
        console.error('File manager modal not found!');
        return;
    }
    document.getElementById('fm-client-id').textContent = clientId;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
    
    // Initialize or re-initialize the file manager for this client
    if (window.modalFileManager) {
        window.modalFileManager.connectToClient(clientId);
    }
}

function closeFileManagerModal() {
    const modal = document.getElementById('fileManagerModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
    if (window.modalFileManager) {
        window.modalFileManager.disconnectFromClient();
    }
}
</script>

<style>
.client-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.client-status-area {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
}

.status-details {
    margin-top: 0.5rem;
}
</style>
{% endblock %}
